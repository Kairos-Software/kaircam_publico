{% extends "principal/base.html" %}
{% load static %}

{% block title %}{% if es_home %}Kaircam Oficial{% else %}{{ streamer_name }}{% endif %} - Streaming en Vivo{% endblock %}

{% block content %}
<div class="stream-layout">
    <div class="stream-main">
        <div class="stream-header">
            <h1 class="stream-title">{{ stream.name }}</h1>
            {% if stream.en_vivo %}
                <span class="badge-live">
                    <span class="live-pulse"></span>
                    EN VIVO
                </span>
            {% else %}
                <span class="badge-offline">OFFLINE</span>
            {% endif %}
        </div>

        <div class="video-container">
            <video 
                id="videoPlayer" 
                class="video-element" 
                controls 
                autoplay 
                muted
                playsinline
            ></video>
            
            <div id="streamStatus" class="stream-status-overlay">
                <div class="status-content">
                    <div class="status-spinner"></div>
                    <p class="status-text" style="color:var(--text-secondary);">Conectando se帽al...</p>
                </div>
            </div>
        </div>

        <div class="channel-info">
            <div class="channel-avatar">
                <img src="{% static 'principal/images/kaircam-icon.png' %}" alt="{{ stream.name }}">
            </div>
            
            <div class="channel-details">
                {% if cliente %}
                    <h2 class="channel-name">{{ cliente.nombre }} {{ cliente.apellido }}</h2>
                {% else %}
                    <h2 class="channel-name">{{ stream.name }}</h2>
                {% endif %}
                
                <p class="channel-category">
                    {% if es_home %}Canal Oficial{% else %}Streaming / Entretenimiento{% endif %}
                </p>

                {% if not es_home and cliente %}
                <div class="social-links">
                    {% if cliente.instagram %}
                    <a href="{{ cliente.instagram }}" target="_blank" class="btn-social" title="Instagram">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
                    </a>
                    {% endif %}

                    {% if cliente.x_twitter %}
                    <a href="{{ cliente.x_twitter }}" target="_blank" class="btn-social" title="X / Twitter">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg>
                    </a>
                    {% endif %}

                    {% if cliente.facebook %}
                    <a href="{{ cliente.facebook }}" target="_blank" class="btn-social" title="Facebook">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>
                    </a>
                    {% endif %}

                    {% if cliente.youtube %}
                    <a href="{{ cliente.youtube }}" target="_blank" class="btn-social" title="YouTube">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.33 29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon></svg>
                    </a>
                    {% endif %}
                    
                    {% if cliente.tiktok %}
                    <a href="{{ cliente.tiktok }}" target="_blank" class="btn-social" title="TikTok">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 12a4 4 0 1 0 4 4V4a5 5 0 0 0 5 5"></path></svg>
                    </a>
                    {% endif %}
                    
                    {% if cliente.discord %}
                    <a href="{{ cliente.discord }}" target="_blank" class="btn-social" title="Discord">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 5.5a19 19 0 0 0-5-2.5 13 13 0 0 0-2 4 15 15 0 0 0-5 0 13 13 0 0 0-2-4 19 19 0 0 0-5 2.5c-3 5.5-3 12-1 16 2.5 2 6 2 8 2 1-1.5 2-3 2-3 1.5 0 3 0 4.5 0 0 0 1 1.5 2 3 2 4 0 2.5 0 5-2 1-1 1-7.5-2-13.5zm-13 11c-1.5 0-2.5-1.5-2.5-3s1-3 2.5-3 2.5 1.5 2.5 3-1 3-2.5 3zm8 0c-1.5 0-2.5-1.5-2.5-3s1-3 2.5-3 2.5 1.5 2.5 3-1 3-2.5 3z"></path></svg>
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <div class="stream-description">
            {% if cliente and cliente.bio %}
                <h4 style="color:var(--brand-red); margin-bottom:8px; text-transform:uppercase;">Biograf铆a</h4>
                <p>{{ cliente.bio }}</p>
            {% else %}
                <p>
                    {% if es_home %}
                    Bienvenidos a Kaircam. Disfruta de la mejor experiencia de streaming con tecnolog铆a de baja latencia.
                    {% else %}
                    Este streamer a煤n no ha a帽adido una biograf铆a. 隆Disfruta de la transmisi贸n!
                    {% endif %}
                </p>
            {% endif %}
        </div>
    </div>

    <aside class="stream-sidebar">
        <div class="chat-container">
            <div class="chat-header">
                <svg class="chat-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                </svg>
                <div class="chat-header-info">
                    <h3>Chat en Vivo</h3>
                </div>
            </div>

            <div id="chatMessages" class="chat-messages">
                </div>

            <div class="chat-input-wrapper">
                <textarea 
                    id="chatInput"
                    class="chat-input"
                    placeholder="Escribe un mensaje..."
                    maxlength="500"
                    rows="1"
                ></textarea>
                <button id="chatSendBtn" class="chat-send-btn">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </aside>
</div>
<div id="guestModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h3> 隆nete al chat!</h3>
        <p>Elige un nombre para chatear (se borrar谩 al salir).</p>
        
        <input type="text" id="guestNicknameInput" placeholder="Tu nombre..." maxlength="20" autofocus>
        <p id="guestError" style="color: #ff4444; font-size: 0.9em; display: none;"></p>
        
        <div class="modal-actions">
            <button id="saveGuestBtn" class="btn-primary">Entrar al Chat</button>
            <button id="cancelGuestBtn" class="btn-secondary">Solo mirar</button>
        </div>
    </div>
</div>
<style>
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.8); z-index: 1000;
        display: flex; justify-content: center; align-items: center;
    }
    .modal-content {
        background: #1a1a1a; padding: 25px; border-radius: 12px;
        width: 90%; max-width: 350px; text-align: center;
        border: 1px solid #333; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    .modal-content h3 { margin-top: 0; color: #fff; }
    .modal-content p { color: #aaa; margin-bottom: 15px; }
    .modal-content input {
        width: 100%; padding: 10px; margin-bottom: 10px;
        background: #333; border: 1px solid #555; color: #fff; border-radius: 6px;
    }
    .modal-actions { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
    .btn-primary { background: var(--brand-red, #e50914); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
    .btn-secondary { background: transparent; color: #aaa; border: 1px solid #555; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
    .btn-primary:hover { opacity: 0.9; }
</style>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
    // 1. CONFIGURACIN INICIAL (Traemos datos de Django al JS)
    window.STREAM_CONFIG = {
        hlsUrl: "{{ stream.hls_url|safe }}",
        isLive: {{ stream.en_vivo|yesno:"true,false" }},
        streamName: "{{ stream.name|escapejs }}",
        isHome: {{ es_home|yesno:"true,false" }},
        // Aqu铆 capturamos el nombre si ya existe en la sesi贸n
        guestName: "{{ guest_name|default:''|escapejs }}" 
    };

    document.addEventListener("DOMContentLoaded", function() {
        // Referencias a los elementos del DOM
        const chatInput = document.getElementById('chatInput');
        const modal = document.getElementById('guestModal');
        const nickInput = document.getElementById('guestNicknameInput');
        const saveBtn = document.getElementById('saveGuestBtn');
        const cancelBtn = document.getElementById('cancelGuestBtn');
        const errorMsg = document.getElementById('guestError');

        // --- LGICA DEL CHAT ---
        
        // Al intentar escribir en el chat...
        chatInput.addEventListener('focus', function(e) {
            // Verificamos si ya tiene nombre (sea registrado o invitado)
            // Asumimos que si es usuario registrado, Django ya manej贸 la sesi贸n, 
            // pero para invitados dependemos de guestName.
            // NOTA: Si tienes l贸gica de usuarios registrados, agr茅gala a la condici贸n aqu铆.
            const hasName = window.STREAM_CONFIG.guestName && window.STREAM_CONFIG.guestName !== '';
            
            if (!hasName) {
                // Si no tiene nombre, quitamos el foco del input y mostramos el modal
                chatInput.blur(); 
                modal.style.display = 'flex';
                nickInput.focus();
            }
        });

        // --- LGICA DEL MODAL ---

        // Bot贸n "Entrar al Chat"
        saveBtn.addEventListener('click', function() {
            const name = nickInput.value.trim();
            
            // Validaci贸n simple cliente
            if (!name) {
                showError("Por favor escribe un nombre.");
                return;
            }

            // Enviamos el nombre al Backend
            fetch("{% url 'set_guest_name' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie('csrftoken') // Necesario para seguridad en Django
                },
                body: JSON.stringify({ nickname: name })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 隆xito!
                    window.STREAM_CONFIG.guestName = data.nickname; // Guardamos en memoria
                    modal.style.display = 'none'; // Cerramos modal
                    
                    // Feedback visual
                    chatInput.placeholder = `Escribiendo como ${data.nickname}...`;
                    chatInput.focus(); // Devolvemos el foco al chat
                    
                    // Limpiamos error
                    errorMsg.style.display = 'none';
                    
                } else {
                    // Error del servidor (ej: nombre muy largo)
                    showError(data.error);
                }
            })
            .catch(err => {
                console.error("Error:", err);
                showError("Error de conexi贸n. Intenta de nuevo.");
            });
        });

        // Bot贸n "Solo mirar" (Cancelar)
        cancelBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });

        // Permitir guardar presionando ENTER en el input del modal
        nickInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveBtn.click();
            }
        });

        // --- FUNCIONES AUXILIARES ---

        function showError(msg) {
            errorMsg.textContent = msg;
            errorMsg.style.display = 'block';
        }

        // Funci贸n est谩ndar de Django para obtener el token CSRF de las cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}